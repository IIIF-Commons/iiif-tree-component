<!DOCTYPE html>
<html>
<head>
    <title>iiif-tree-component: test</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="css/iiif-tree-component.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsviews/0.9.76/jsviews.min.js"></script>
    <script src="js/ex.es3.min.js"></script>
    <script src="js/extensions.min.js"></script>
    <script src="js/utils.min.js"></script>
    <script src="js/base-component.min.js"></script>
    <script src="js/iiif-tree-component.js"></script>
    <script src="js/manifesto.js"></script>
    <script src="js/manifold.js"></script>
</head>
<body>
    
    <div>
        <input id="multiselect" type="checkbox" /><label for="multiselect">Multi-select</label>&nbsp;
        <input id="selectAll" type="checkbox" /><label for="selectAll">Select All</label>&nbsp;
        Sort by: <a id="sortByDefault" href="#">Default</a>/<a href="#" id="sortByDate">Date</a> &nbsp;
    </div>
    
    <div id="tree">
        loading...
    </div>

    <script>

        var helper, component, rootNode, multiSelectState;
        
        $(function() {
            
            // http://wellcomelibrary.org/iiif/b18035723/manifest (Wunder der Vererbung)
            // http://wellcomelibrary.org/iiif/collection/b19974760 (Chemist and Druggist)
            // http://wellcomelibrary.org/iiif/collection/b18031511 (Biological Basis of Medicine)
            // http://digital.library.villanova.edu/Collection/vudl:3/IIIF (Villanova Collection)

            Manifold.loadManifest({
                iiifResourceUri: 'http://wellcomelibrary.org/iiif/collection/b19974760',
                licenseMap: {},
                collectionIndex: 0,
                manifestIndex: 0,
                sequenceIndex: 0,
                canvasIndex: 0
            }).then(function(h){
                
                helper = h;
                
                component = new IIIFComponents.TreeComponent({
                    element: "#tree"
                });

                component.on('treeNodeSelected', function(args) {
                    var node = args[0];
                    console.log('selected: ' + node.label);
                });
                
                component.on('treeNodeMultiSelected', function(args) {
                    var node = args[0];
                    var range = node.data;
                    multiSelectState.selectRange(range, node.multiSelected);                    
                    console.log('multi-selected: ' + node.label);                    
                    multiSelectStateChanged();
                });
                
                databindTree(Manifold.TreeSortType.none);               

            }).catch(function() {
                console.error('failed to load manifest');
            });
            
            function databindTree(treeSortType) {
                rootNode = helper.getTree(treeSortType);  
                component.databind(rootNode);
                
                multiSelectState = helper.getMultiSelectState();                
                multiSelectStateChanged(); 
            }
            
            function multiSelectStateChanged() {
                $('#selectAll').prop('checked', multiSelectState.allRangesSelected());                
                $('#multiselect').prop('checked', multiSelectState.enabled);
                component.updateMultiSelectState(multiSelectState);                
                console.log(multiSelectState.getAllSelectedCanvases());
            }

            $('#multiselect').on('click', function() {
                var $this = $(this);
                
                if ($this.is(':checked')) {
                    multiSelectState.setEnabled(true);
                } else {
                    multiSelectState.setEnabled(false);
                }
                
                multiSelectStateChanged();
            });
            
            $('#selectAll').on('click', function() {
                var $this = $(this);
                
                if ($this.is(':checked')) {
                    multiSelectState.selectAllRanges(true);
                } else {
                    multiSelectState.selectAllRanges(false);
                }
                
                multiSelectStateChanged();
            });
            
            $('#sortByDate').on('click', function(e) {
                e.preventDefault();
                databindTree(Manifold.TreeSortType.date);
            });
            
            $('#sortByDefault').on('click', function(e) {
                e.preventDefault();                
                databindTree(Manifold.TreeSortType.none);
            });
            
        });
    </script>
</body>
</html>